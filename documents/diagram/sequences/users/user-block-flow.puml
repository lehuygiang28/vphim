@startuml User Block Flow

actor "Admin User" as adminUser
participant "UserUpdateComponent (Next.js Admin)" as userUpdateComponent <<Component>>
participant "UsersResolver" as usersResolver <<Resolver>>
participant "UsersService" as usersService <<Service>>
participant "UsersRepository" as usersRepository <<Repository>>
database "MongoDB" as mongoDB <<Database>>
participant "ConfigService" as configService <<Service>>
participant "UsersController" as usersController <<Controller>>



participant "ConfigService" as ConfigService

userUpdateComponent -> usersController: PATCH /users/block/{id}\nBlockUserDto
activate usersController

usersController -> usersService: blockUser({ actor, userId, data })
activate usersService

usersService -> usersService: findByIdOrThrow(actor.userId)
activate usersService #DarkSalmon
usersService -> usersRepository: findOne(actor._id)
usersRepository -> mongoDB: Query user
mongoDB --> usersRepository: User document
usersRepository --> usersService: Return user or null
alt User not found
    usersService --> usersService: Throw UnprocessableEntityException
end
usersService --> usersService: Return actor user
deactivate usersService

alt Actor role is not Admin
    usersService --> usersController: Throw HttpException\n(UNAUTHORIZED)
    usersController --> userUpdateComponent: HTTP 401 Unauthorized
else Actor is blocked
    usersService --> usersController: Throw HttpException\n(UNPROCESSABLE_ENTITY)
    usersController --> userUpdateComponent: HTTP 422 Error Response
else Actor is Admin and not blocked
    usersService -> usersService: findByIdOrThrow(userId)
    activate usersService #DarkSalmon
    usersService -> usersRepository: findOne(userId)
    usersRepository -> mongoDB: Query user
    mongoDB --> usersRepository: User document
    usersRepository --> usersService: Return user or null
    alt User not found
        usersService --> usersService: Throw UnprocessableEntityException
    end
    usersService --> usersService: Return target user
    deactivate usersService

    usersService -> configService: get('auth.adminEmail')
    configService --> usersService: Return admin email

    alt Target user is root admin
        usersService --> usersController: Throw HttpException\n(UNPROCESSABLE_ENTITY)
        usersController --> userUpdateComponent: HTTP 422 Error Response
    else Actor is trying to block themselves
        usersService --> usersController: Throw HttpException\n(UNPROCESSABLE_ENTITY)
        usersController --> userUpdateComponent: HTTP 422 Error Response
    else Target user is already blocked
        usersService --> usersController: Throw HttpException\n(UNPROCESSABLE_ENTITY)
        usersController --> userUpdateComponent: HTTP 422 Error Response
    else Valid block request
        usersService -> usersService: Create blockLog with\naction=block, timestamp, actor ID

        usersService -> usersRepository: findOneAndUpdate(userId, updateQuery)
        activate usersRepository
        usersRepository -> mongoDB: Update user with isBlocked=true and blockLog
        mongoDB --> usersRepository: Updated user document
        usersRepository --> usersService: Return updated user
        deactivate usersRepository

        usersService --> usersController: Return updated User
        usersController --> userUpdateComponent: HTTP 200 OK\nUserDto
    end
end

deactivate usersService
deactivate usersController

@enduml
