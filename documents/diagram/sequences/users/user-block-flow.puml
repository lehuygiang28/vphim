@startuml User Block Flow

actor "Admin Client" as Client
participant "UsersController" as Controller
participant "UsersService" as Service
participant "UsersRepository" as Repository
database "MongoDB" as DB
participant "ConfigService" as ConfigService

Client -> Controller: PATCH /users/block/{id}\nBlockUserDto
activate Controller

Controller -> Service: blockUser({ actor, userId, data })
activate Service

Service -> Service: findByIdOrThrow(actor.userId)
activate Service #DarkSalmon
Service -> Repository: findOne(actor._id)
Repository -> DB: Query user
DB --> Repository: User document
Repository --> Service: Return user or null
alt User not found
    Service --> Service: Throw UnprocessableEntityException
end
Service --> Service: Return actor user
deactivate Service

alt Actor role is not Admin
    Service --> Controller: Throw HttpException\n(UNAUTHORIZED)
    Controller --> Client: HTTP 401 Unauthorized
else Actor is blocked
    Service --> Controller: Throw HttpException\n(UNPROCESSABLE_ENTITY)
    Controller --> Client: HTTP 422 Error Response
else Actor is Admin and not blocked
    Service -> Service: findByIdOrThrow(userId)
    activate Service #DarkSalmon
    Service -> Repository: findOne(userId)
    Repository -> DB: Query user
    DB --> Repository: User document
    Repository --> Service: Return user or null
    alt User not found
        Service --> Service: Throw UnprocessableEntityException
    end
    Service --> Service: Return target user
    deactivate Service
    
    Service -> ConfigService: get('auth.adminEmail')
    ConfigService --> Service: Return admin email
    
    alt Target user is root admin
        Service --> Controller: Throw HttpException\n(UNPROCESSABLE_ENTITY)
        Controller --> Client: HTTP 422 Error Response
    else Actor is trying to block themselves
        Service --> Controller: Throw HttpException\n(UNPROCESSABLE_ENTITY)
        Controller --> Client: HTTP 422 Error Response
    else Target user is already blocked
        Service --> Controller: Throw HttpException\n(UNPROCESSABLE_ENTITY)
        Controller --> Client: HTTP 422 Error Response
    else Valid block request
        Service -> Service: Create blockLog with\naction=block, timestamp, actor ID
        
        Service -> Repository: findOneAndUpdate(userId, updateQuery)
        activate Repository
        Repository -> DB: Update user with isBlocked=true and blockLog
        DB --> Repository: Updated user document
        Repository --> Service: Return updated user
        deactivate Repository
        
        Service --> Controller: Return updated User
        Controller --> Client: HTTP 200 OK\nUserDto
    end
end

deactivate Service
deactivate Controller

@enduml 