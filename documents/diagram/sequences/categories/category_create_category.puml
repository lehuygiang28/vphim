@startuml Category - Create Category

actor "Admin" as Client
participant "CategoryResolver" as Resolver
participant "RequiredRoles Guard" as Guard
participant "CategoryService" as Service
participant "CategoryRepository" as Repo
database "MongoDB" as DB

Client -> Resolver: mutation createCategory(input)
activate Resolver

Resolver -> Guard: check admin role
activate Guard
alt user is admin
    Guard --> Resolver: allow
else user is not admin
    Guard --> Client: throw ForbiddenException
    deactivate Resolver
    deactivate Guard
end
deactivate Guard

Resolver -> CategoryService: createCategory(input)
activate CategoryService

Service -> CategoryRepository: findOne(filterQuery: {slug})
activate CategoryRepository
Repo -> DB: findOne({slug})
activate DB
DB --> CategoryRepository: return existing category or null
deactivate DB
Repo --> CategoryService: return result
deactivate CategoryRepository

alt slug already exists
    Service --> Resolver: throw HttpException(UNPROCESSABLE_ENTITY)
else slug is unique
    Service -> CategoryService: process slug (removeDiacritics, removeTone)
    
    Service -> CategoryRepository: create(document)
    activate CategoryRepository
    Repo -> DB: save new category
    activate DB
    DB --> CategoryRepository: return saved category
    deactivate DB
    Repo --> CategoryService: return new category
    deactivate CategoryRepository
    
    Service --> Resolver: return new category
end

deactivate CategoryService
Resolver --> Client: return created category
deactivate Resolver

@enduml 