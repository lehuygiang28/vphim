@startuml Email Confirmation Flow
!theme plain
skinparam sequenceMessageAlign center
skinparam maxMessageSize 250
skinparam noteFontSize 12
skinparam BoxPadding 10

autonumber

title Email Confirmation Flow
caption Verification process after user registration

actor User #Black
participant "Frontend" as FE #PaleGreen
participant "AuthController" as AC #LightBlue
participant "AuthService" as AS #LightBlue
participant "JwtService" as JWT #Orange
participant "UsersService" as US #LightBlue
participant "Redis" as Redis #Pink
participant "Database" as DB #Gray

User -> FE ++ : Click confirmation link
note right of User: Clicks link from registration email
FE -> AC ++ : POST /auth/register/confirm (hash)
AC -> AS ++ : registerConfirm(hash)

AS -> JWT ++ : verifyAsync hash
note right: Validates token signature and expiry
return decoded data or error

alt Invalid hash
    AS --> AC -- : throw UnprocessableEntityException
    AC --> FE -- : 422 Invalid hash
    FE --> User -- : Show error message
else Valid hash
    AS -> AS ++ : Extract userId from JWT payload
    return userId

    AS -> US ++ : findById(userId)
    US -> DB ++ : query
    return user
    deactivate US

    AS -> AS ++ : Generate key "auth:confirmEmailHash:{userId}"
    return key

    AS -> Redis ++ : existsUniqueKey(key)
    return exists status

    alt Hash doesn't exist or user already confirmed
        AS --> AC -- : throw UnprocessableEntityException
        AC --> FE -- : 422 Error message
        FE --> User -- : Show error message
    else Hash valid and user not confirmed
        AS -> Redis ++ : del(key)
        return confirm deleted

        AS -> US ++ : update user (emailVerified: true)
        US -> DB ++ : update
        return updated
        deactivate US

        AS --> AC -- : void (204 No Content)
        AC --> FE -- : 204 No Content
        FE --> User -- : Show success message
    end
end

@enduml
